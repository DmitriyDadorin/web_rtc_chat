<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>WebRTC: –≠–∫—Ä–∞–Ω —á–µ—Ä–µ–∑ QR</title>
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; margin: 1rem; }
    video { width: 100%; max-height: 300px; margin-top: 1rem; background: black; }
    #qr, #scan { margin-top: 1rem; }
  </style>
</head>
<body>
  <h2>üì∫ WebRTC —ç–∫—Ä–∞–Ω —á–µ—Ä–µ–∑ QR</h2>

  <button onclick="initOffer()">1. –°–æ–∑–¥–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (Offer + QR)</button>
  <div id="qr"></div>

  <button onclick="startScan()">2. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è (–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR)</button>
  <div id="scan" style="width: 300px;"></div>

  <video id="remoteVideo" autoplay playsinline></video>

  <script>
    let pc = new RTCPeerConnection();
    const qrEl = document.getElementById('qr');
    const videoEl = document.getElementById('remoteVideo');

    function compress(data) {
      return LZString.compressToEncodedURIComponent(JSON.stringify(data));
    }

    function decompress(str) {
      return JSON.parse(LZString.decompressFromEncodedURIComponent(str));
    }

    async function initOffer() {
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      pc.onicecandidate = async (e) => {
        if (e.candidate) return;

        const payload = compress({ sdp: pc.localDescription });
        qrEl.innerHTML = '';
        QRCode.toCanvas(document.createElement('canvas'), payload, (err, canvas) => {
          if (err) return console.error(err);
          qrEl.appendChild(canvas);
        });
      };

      // –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      pc.onconnectionstatechange = async () => {
        if (pc.connectionState === "connected") {
          try {
            const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            stream.getTracks().forEach(track => pc.addTrack(track, stream));
            console.log("–≠–∫—Ä–∞–Ω —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç—Å—è.");
          } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —ç–∫—Ä–∞–Ω—É", err);
          }
        }
      };
    }

    async function startScan() {
      const qrScanner = new Html5Qrcode('scan');
      qrScanner.start(
        { facingMode: 'environment' },
        { fps: 10, qrbox: 250 },
        async (text) => {
          const { sdp } = decompress(text);
          await qrScanner.stop();
          document.getElementById('scan').innerHTML = '';

          if (sdp.type === 'offer') {
            pc.ontrack = (e) => {
              videoEl.srcObject = e.streams[0];
            };
            await pc.setRemoteDescription(sdp);
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            pc.onicecandidate = (e) => {
              if (e.candidate) return;
              const answerPayload = compress({ sdp: pc.localDescription });
              qrEl.innerHTML = '';
              QRCode.toCanvas(document.createElement('canvas'), answerPayload, (err, canvas) => {
                if (err) return console.error(err);
                qrEl.appendChild(canvas);
              });
            };
          } else if (sdp.type === 'answer') {
            await pc.setRemoteDescription(sdp);
          }
        }
      );
    }
  </script>
</body>
</html>
