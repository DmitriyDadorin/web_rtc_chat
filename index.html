<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–æ–≤ —á–µ—Ä–µ–∑ WebRTC</title>
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; margin: 1rem; }
    #qr, #scan, #preview { margin-top: 1rem; }
    iframe { width: 100%; height: 300px; border: 1px solid #ccc; margin-top: 1rem; }
    textarea { width: 100%; height: 150px; margin-top: 1rem; }
  </style>
</head>
<body>
  <h2>üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è HTML —á–µ—Ä–µ–∑ QR + WebRTC</h2>

  <button onclick="startSender()">1. –Ø –æ—Ç–ø—Ä–∞–≤–ª—è—é (QR)</button>
  <div id="qr"></div>

  <button onclick="startReceiver()">2. –Ø –ø—Ä–∏–Ω–∏–º–∞—é (—Å–∫–∞–Ω–∏—Ä—É—é QR)</button>
  <div id="scan" style="width: 300px;"></div>

  <textarea id="htmlInput" placeholder="–í–≤–µ–¥–∏—Ç–µ HTML-–∫–æ–¥ –¥–ª—è —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏...">
<h1>–ü—Ä–∏–≤–µ—Ç üëã</h1>
<p>–≠—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –ø–æ WebRTC!</p>
  </textarea>

  <iframe id="preview"></iframe>

  <script>
    let pc = new RTCPeerConnection();
    let dataChannel;
    const htmlInput = document.getElementById('htmlInput');
    const preview = document.getElementById('preview');
    const qrEl = document.getElementById('qr');

    function compress(data) {
      return LZString.compressToEncodedURIComponent(JSON.stringify(data));
    }

    function decompress(str) {
      return JSON.parse(LZString.decompressFromEncodedURIComponent(str));
    }

    function sendHtml() {
      const html = htmlInput.value;
      preview.srcdoc = html;
      if (dataChannel?.readyState === 'open') {
        dataChannel.send(html);
      }
    }

    htmlInput.addEventListener('input', () => {
      sendHtml();
    });

    async function startSender() {
      dataChannel = pc.createDataChannel('sync');
      setupChannel();

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      pc.onicecandidate = (e) => {
        if (e.candidate) return;
        const payload = compress({ sdp: pc.localDescription });
        qrEl.innerHTML = '';
        QRCode.toCanvas(document.createElement('canvas'), payload, (err, canvas) => {
          if (err) return console.error(err);
          qrEl.appendChild(canvas);
        });
      };
    }

    async function startReceiver() {
      const qrScanner = new Html5Qrcode('scan');
      qrScanner.start(
        { facingMode: 'environment' },
        { fps: 10, qrbox: 250 },
        async (text) => {
          const { sdp } = decompress(text);
          await qrScanner.stop();
          document.getElementById('scan').innerHTML = '';

          pc.ondatachannel = (e) => {
            dataChannel = e.channel;
            setupChannel();
          };

          await pc.setRemoteDescription(sdp);
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);

          pc.onicecandidate = (e) => {
            if (e.candidate) return;
            const answerPayload = compress({ sdp: pc.localDescription });
            qrEl.innerHTML = '';
            QRCode.toCanvas(document.createElement('canvas'), answerPayload, (err, canvas) => {
              if (err) return console.error(err);
              qrEl.appendChild(canvas);
            });
          };
        }
      );
    }

    function setupChannel() {
      if (!dataChannel) return;
      dataChannel.onopen = () => sendHtml();
      dataChannel.onmessage = (e) => {
        preview.srcdoc = e.data;
      };
    }
  </script>
</body>
</html>
