<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Сопряжение P2P через WebRTC с двухсторонним обменом QR-кодов</title>
  <!-- Tailwind CSS через CDN -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Библиотеки для сжатия, генерации QR и сканера QR -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Экран сопряжения -->
  <div id="pairingUI" class="max-w-md mx-auto mt-10 p-6 bg-white rounded shadow">
    <h2 class="text-2xl font-bold mb-4">Пошаговое сопряжение</h2>
    <p class="mb-4">Выберите свою роль:</p>
    <div class="flex justify-between mb-4">
      <button id="managerBtn" class="bg-blue-500 text-white px-4 py-2 rounded">Стать Менеджером</button>
      <button id="clientBtn" class="bg-green-500 text-white px-4 py-2 rounded">Стать Клиентом</button>
    </div>
    <!-- Контейнер для отображения QR-кода (сгенерированного offer или answer) -->
    <div id="qrContainer" class="mb-4"></div>
    <!-- Кнопка для сканирования QR (используется менеджером для считывания answer) -->
    <div id="managerScanArea" class="hidden mb-4">
      <button id="managerScanBtn" class="bg-purple-500 text-white px-4 py-2 rounded w-full">Сканировать QR-код ответа</button>
      <div id="managerScanContainer" class="mt-4"></div>
    </div>
    <!-- Контейнер для сканирования (используется клиентом для считывания offer) -->
    <div id="scanContainer" class="mb-4"></div>
  </div>

  <!-- Основной интерфейс (скрыт до установления соединения) -->
  <div id="mainUI" class="max-w-4xl mx-auto mt-8 p-6 bg-white rounded shadow hidden">
    <div class="flex justify-between items-center">
      <h2 class="text-2xl font-bold">Синхронизированный экран</h2>
      <span id="roleBadge" class="px-3 py-1 bg-gray-200 rounded font-semibold"></span>
    </div>
    <!-- Блок с информацией о кредите -->
    <div class="mt-6 p-4 bg-gray-50 rounded border">
      <h3 class="text-xl font-semibold mb-4">Ознакомьтесь с информацией о кредите</h3>
      <p class="mb-4">
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec vitae orci nec massa fermentum bibendum. 
        Vivamus eget felis nec sapien euismod ullamcorper. Phasellus at nisl ut lorem consectetur tincidunt.
        Praesent vulputate, neque sit amet pharetra commodo, odio lacus porttitor ligula, ut convallis sem libero ut ex.
        Nulla facilisi. Integer ac nisi eget dolor malesuada vulputate. Sed ornare nulla ac justo placerat, nec 
        pulvinar nunc tristique. Suspendisse potenti.
      </p>
      <!-- Кнопка "Взять кредит" -->
      <button id="takeCreditBtn" class="bg-blue-500 text-white px-4 py-2 rounded">Взять кредит</button>
    </div>
  </div>

  <!-- Модальное окно для подтверждения кредита -->
  <div id="modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white p-6 rounded shadow max-w-sm mx-auto">
      <h3 class="text-xl font-bold mb-4">Подтвердите взятие кредита</h3>
      <div class="flex justify-end space-x-4">
        <button id="confirmCreditBtn" class="bg-green-500 text-white px-4 py-2 rounded">Подтвердить</button>
        <button id="cancelCreditBtn" class="bg-red-500 text-white px-4 py-2 rounded">Отмена</button>
      </div>
    </div>
  </div>

  <!-- Чат-виджет в правом нижнем углу -->
  <div id="chatWidget" class="fixed bottom-4 right-4 bg-white p-4 shadow rounded w-64">
    <h4 class="font-bold mb-2">Чат</h4>
    <div id="chatMessages" class="h-40 overflow-y-auto border p-2 mb-2"></div>
    <div class="flex">
      <input id="chatInput" class="flex-grow border rounded-l px-2" placeholder="Введите сообщение...">
      <button id="sendChatBtn" class="bg-blue-500 text-white px-3 rounded-r">Отправить</button>
    </div>
  </div>

  <script>
    // Глобальные переменные
    const pc = new RTCPeerConnection();
    let dataChannel = null;
    let userRole = "";

    // Элементы интерфейса
    const pairingUI = document.getElementById('pairingUI');
    const mainUI = document.getElementById('mainUI');
    const roleBadge = document.getElementById('roleBadge');
    const qrContainer = document.getElementById('qrContainer');
    const scanContainer = document.getElementById('scanContainer');
    const managerScanArea = document.getElementById('managerScanArea');
    const managerScanBtn = document.getElementById('managerScanBtn');
    const managerScanContainer = document.getElementById('managerScanContainer');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendChatBtn = document.getElementById('sendChatBtn');
    const takeCreditBtn = document.getElementById('takeCreditBtn');
    const modal = document.getElementById('modal');
    const confirmCreditBtn = document.getElementById('confirmCreditBtn');
    const cancelCreditBtn = document.getElementById('cancelCreditBtn');

    // Функции сжатия и распаковки данных
    function compress(data) {
      return LZString.compressToEncodedURIComponent(JSON.stringify(data));
    }
    function decompress(str) {
      return JSON.parse(LZString.decompressFromEncodedURIComponent(str));
    }

    // Отправка сообщений через dataChannel (формат JSON)
    function sendSyncMessage(message) {
      if (dataChannel && dataChannel.readyState === 'open') {
        dataChannel.send(JSON.stringify(message));
      }
    }

    // Функция добавления сообщений в чат
    function appendChatMessage(sender, text) {
      const div = document.createElement('div');
      div.className = "mb-2";
      div.textContent = `${sender}: ${text}`;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Настройка dataChannel
    function setupDataChannel() {
      if (!dataChannel) return;
      dataChannel.onopen = () => {
        // По открытию канала скрываем экран сопряжения и показываем основной интерфейс
        pairingUI.classList.add('hidden');
        mainUI.classList.remove('hidden');
        roleBadge.textContent = userRole;
        // Если устройство имеет роль Менеджера, блокировка кнопки "Взять кредит"
        if (userRole === "Менеджер") {
          takeCreditBtn.disabled = true;
        }
      };

      dataChannel.onmessage = (event) => {
        let msg = JSON.parse(event.data);
        switch (msg.type) {
          case 'chat':
            appendChatMessage("Партнер", msg.message);
            break;
          case 'creditAccepted':
            if (userRole === "Менеджер") {
              appendChatMessage("Система", "Клиент принял кредит");
            }
            break;
          default:
            console.log("Неизвестное сообщение:", msg);
        }
      };
    }

    // Функция для менеджера: создание offer и генерация QR-кода
    async function startManager() {
      userRole = "Менеджер";
      // Создаем dataChannel
      dataChannel = pc.createDataChannel('sync');
      setupDataChannel();

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      pc.onicecandidate = (e) => {
        if (e.candidate) return;
        const payload = compress({ sdp: pc.localDescription });
        qrContainer.innerHTML = "";
        // Генерация QR-кода для offer
        QRCode.toCanvas(document.createElement('canvas'), payload, (err, canvas) => {
          if (err) return console.error(err);
          qrContainer.appendChild(canvas);
        });
        // Для менеджера теперь включаем область для сканирования ответа
        managerScanArea.classList.remove('hidden');
      };
    }

    // Функция для клиента: сканирование offer, создание answer и генерация QR-кода
    async function startClient() {
      userRole = "Клиент";
      const html5QrCode = new Html5Qrcode("scanContainer");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        async (decodedText, decodedResult) => {
          // Остановка сканера после считывания offer
          await html5QrCode.stop();
          scanContainer.innerHTML = "";

          const data = decompress(decodedText);
          await pc.setRemoteDescription(data.sdp);

          // При получении dataChannel на стороне клиента
          pc.ondatachannel = (event) => {
            dataChannel = event.channel;
            setupDataChannel();
          };

          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);

          pc.onicecandidate = (e) => {
            if (e.candidate) return;
            const answerPayload = compress({ sdp: pc.localDescription });
            qrContainer.innerHTML = "";
            // Генерация QR-кода для answer
            QRCode.toCanvas(document.createElement('canvas'), answerPayload, (err, canvas) => {
              if (err) return console.error(err);
              qrContainer.appendChild(canvas);
            });
          };
        }
      );
    }

    // Функция для менеджера: сканирование QR-кода с answer от клиента
    async function startManagerScan() {
      const html5QrCode = new Html5Qrcode("managerScanContainer");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        async (decodedText, decodedResult) => {
          await html5QrCode.stop();
          managerScanContainer.innerHTML = "";

          const data = decompress(decodedText);
          await pc.setRemoteDescription(data.sdp);
        }
      );
    }

    // Обработчики для кнопок выбора роли
    document.getElementById('managerBtn').addEventListener('click', startManager);
    document.getElementById('clientBtn').addEventListener('click', startClient);
    managerScanBtn.addEventListener('click', startManagerScan);

    // Чат: отправка сообщений
    sendChatBtn.addEventListener('click', () => {
      const message = chatInput.value.trim();
      if (message) {
        appendChatMessage(userRole, message);
        sendSyncMessage({ type: "chat", message: message });
        chatInput.value = "";
      }
    });
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendChatBtn.click();
      }
    });

    // Обработчик кнопки "Взять кредит"
    takeCreditBtn.addEventListener('click', () => {
      if (userRole === "Клиент") {
        modal.classList.remove('hidden');
      }
    });

    // Подтверждение кредита
    confirmCreditBtn.addEventListener('click', () => {
      sendSyncMessage({ type: "creditAccepted" });
      appendChatMessage("Система", "Вы приняли кредит");
      modal.classList.add('hidden');
      takeCreditBtn.disabled = true;
    });

    cancelCreditBtn.addEventListener('click', () => {
      modal.classList.add('hidden');
    });
  </script>
</body>
</html>
